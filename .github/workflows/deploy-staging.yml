name: Deploy to Staging

on:
  push:
    branches:
      - main

jobs:
  test:
    name: Run Tests with Real API Calls
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      SECRET_KEY: django-insecure-test-key-ci-github-actions-only
      DJANGO_SETTINGS_MODULE: benefits.settings
      DB_NAME: test_benefits_db
      DB_USER: postgres
      DB_PASS: postgres
      DB_HOST: localhost
      DB_PORT: 5432
      ENABLE_GOOGLE_INTEGRATIONS: false

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_benefits_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d test_benefits_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tests
        uses: ./.github/actions/run-tests
        with:
          vcr-mode: new_episodes
          upload-coverage: 'false'
          hud-api-token: ${{ secrets.HUD_API_TOKEN }}

  lint:
    name: Check Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: psf/black@stable
        with:
          options: --check --verbose
          src: .

  deploy:
    needs: [test, lint]
    name: Deploy Backend to Heroku Staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Heroku
        uses: ./.github/actions/deploy-to-heroku
        with:
          heroku-api-key: ${{ secrets.HEROKU_API_KEY }}
          heroku-app-name: ${{ secrets.HEROKU_STAGING_APP_NAME }}
          heroku-email: ${{ secrets.HEROKU_EMAIL }}

      - name: Get commit info
        id: commit_info
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -n 1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Run post-deployment scripts
        if: success()
        id: post_deploy
        uses: ./.github/actions/heroku-post-deploy
        with:
          heroku-api-key: ${{ secrets.HEROKU_API_KEY }}
          heroku-app-name: ${{ secrets.HEROKU_STAGING_APP_NAME }}
          validation-sheet-id: ${{ secrets.VALIDATION_SHEET_ID }}

      - name: Send success notification to Slack
        if: success()
        uses: ./.github/actions/slack-notify
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: success
          environment: staging
          commit-sha: ${{ steps.commit_info.outputs.sha }}
          commit-message: ${{ steps.commit_info.outputs.message }}
          commit-author: ${{ steps.commit_info.outputs.author }}

      - name: Send failure notification to Slack
        if: failure()
        uses: ./.github/actions/slack-notify
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: failure
          environment: staging
          commit-sha: ${{ steps.commit_info.outputs.sha }}
          commit-message: ${{ steps.commit_info.outputs.message }}
          commit-author: ${{ steps.commit_info.outputs.author }}
